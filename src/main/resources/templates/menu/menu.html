<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<title>伟大的渺小</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="icon" th:href="@{/static/logo.png}">
	<link th:href="@{/static/layui/css/layui.css}" type="text/css" media="screen" rel="stylesheet"/>
	<link th:href="@{/static/css/ztree/metroStyle/metroStyle.css}"type="text/css" media="screen" rel="stylesheet"/>
	<link th:href="@{/static/css/ztree/demo.css}" type="text/css" media="screen" rel="stylesheet"/>
	<link th:href="@{/static/css/common.css}"  type="text/css" media="screen" rel="stylesheet"/>
	<script type="text/javascript" th:src="@{/static/js/jquery.min.js}" ></script>
	<script type="text/javascript" th:src="@{/static/layui/layui.js}" ></script>
	<script type="text/javascript" th:src="@{/static/js/ztree/jquery.ztree.all.js}" ></script>
	<style type="text/css">
		ul.ztree {
			margin-top: 10px;
			border: 0px solid #617775;
			background: #ffffff;
			width:98%;
			height:100%;
			overflow-y:scroll;
			overflow-x:auto;
		}
	</style>
	<script>
	    var zTreeObj1;
	    var layerid;
        var className = "dark";

	    //一般直接写在一个js文件中
	    layui.use(['layer', 'form','table'],  function(){
	        var layer = layui.layer
	                ,form = layui.form
	                ,$ = layui.$
	                ,laytpl = layui.laytpl
	                ,table = layui.table;
	      //自定义验证规则
          form.verify({
        	  content: function(value) {
                    if(value.length < 1) {
                        return '输入的字符不能为空';
                    }
                }
            });
	      
	        pageInit();
	        
	        $("#choseIcon").click(function(){
	            layer.open({
	                type: 2,
	                area:['95%', '95%'],
	                content:'/static/page/systemSetting/icons.html',
	                shadeClose:true,
	                end: function(){
	                    $("#icon").select();
	                }
	            });
	            return false;
	        });
	    });
	    
	    
	    function pageInit() {
	        // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
	        var setting = {
	            view: {
	                addHoverDom: addHoverDom,//添加鼠标悬浮事件
	                removeHoverDom: removeHoverDom,//鼠标悬浮接触事件
	                selectedMulti: false
	            },
	            edit: {
	                enable: true,//允许编辑
	                editNameSelectAll: true,
	                showRemoveBtn: showRemoveBtn//显示删除按钮
	            },
	            callback: {
	                beforeEditName: beforeEditName,
//                beforeRemove: beforeRemove,//删除前触发事件
	                onRemove: onRemove//删除触发
	            }
	        };
	
	        //移除鼠标悬浮时临时增加的按钮
	        function removeHoverDom(treeId, treeNode) {
	            $("#addBtn_"+treeNode.tId).unbind().remove();
	        };
	
	        // zTree 的数据属性，深入使用请参考 API 文档（zTreeNode 节点数据详解）
	        var zNodes = [
	            {name:"test1", open:true, children:[
	                {name:"test1_1"}, {name:"test1_2"}]},
	            {name:"test2", open:true, children:[
	                {name:"test2_1"}, {name:"test2_2"}]}
	        ];
	        //初始化ztree(注意是-1)
	        $.ajax({
	            type: "POST",
	            url:'/menu/loadCheckMenuInfo?parentId=-1',
	            async: false,
	            dataType: 'json',
	            timeout: 1000,
	            cache: false,
	            error: function(request) {
	                layer.alert("与服务器连接失败/(ㄒoㄒ)/~~");
	            },
	            success: function(data) {
	                zNodes=data;
	                zTreeObj1 = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
	            }
	        });
	        
	        //监听提交(新增和编辑)
	        layui.form.on('submit(addeditsubmitfilter)', function(data) {
	            //为了防止form中的id值被点击重置后置空,将编辑的id存放在label中，在表单提交时从label中提取出值，赋给表单input
	            $("#pId").val($("#editlabelpId").html());
	            $("#editid").val($("#editlabelid").html());
	            $.ajax({
	                type: "POST",
	                url:"/menu/addupdatemenu",
	                data:$('#addeditformid').serialize(),
	                async: false,
	                error: function(request) {
	                    layer.alert("与服务器连接失败/(ㄒoㄒ)/~~");
	                },
	                success: function(data) {
	                	
	                	if(data.state=='fail'){
                        	layer.msg('操作失败,失败原因'+data.mesg, {icon: 2});
                        	layer.close(layerid);
                        	pageInit();
                        }
                        if(data.state=='success'){
                        	layer.msg('操作成功', {icon: 1});
                        	layer.close(layerid);
                        	pageInit();
                        }
	                    
	                }
	            });
	            return false;
	        });
	    }
	    
	    
	    //哪些节点会显示删除按钮，哪些节点不会显示
        function showRemoveBtn(treeId, treeNode) {
	    	
            return treeNode.name!='systemeSttings'
                    &&treeNode.name!='菜单管理'
                    &&treeNode.name!='角色管理'
                    &&treeNode.name!='用户管理'
                    && treeNode.pId !='-1';
        }
	    
        //删除时触发
        function onRemove(e, treeId, treeNode) {
        	
        	layer.confirm("确认删除节点 [" + treeNode.name + "]吗？", {
        		  btn: ['确定','取消'] //按钮
        		}, function(){
        			$.ajax({
                        type: "POST",
                        url:"/menu/deletemenu",
                        data:{id:treeNode.id},
                        async: false,
                        error: function(request) {
                            layer.alert("与服务器连接失败/(ㄒoㄒ)/~~");
                        },
                        success: function(data) {
                        	if(data.state=='fail'){
                            	layer.msg('操作失败,失败原因'+data.mesg, {icon: 2});
                            	layer.close(layerid);
                            	pageInit();
                            }
                            if(data.state=='success'){
                            	layer.msg('操作成功', {icon: 1});
                            	layer.close(layerid);
                            	pageInit();
                            }
                        }
                    });
        		});
        }
        
        
        function beforeEditName(treeId, treeNode) {
            className = (className === "dark" ? "":"dark");
            var zTree = $.fn.zTree.getZTreeObj("treeDemo");
            zTree.selectNode(treeNode);
            //根据id获取菜单节点对象的数据并填充进编辑的表单中
            $.ajax({
                type: "POST",
                url:"/menu/selectMenuById",
                data:{id:treeNode.id},
                async: false,
                error: function(request) {
                    layer.alert("与服务器连接失败/(ㄒoㄒ)/~~");
                },
                success: function(data) {
                    if(data.state=='fail'){
                        layer.open({
                            skin: 'layui-layer-molv',
                            type:1,
                            area:"20%",
                            content:data.mesg,
                            shadeClose:true,
                            end: function(){
                                layer.close(layerid);
                                window.location.reload();//刷新框架
                            }
                        });
                        return false;
                    }
                    if(data.state=='success'){
                        $("#editlabelid").html(treeNode.id);//设置父节点id，表单中仅需要提供父级节点的id即可，后台会根据pId查询
                        $("#icon").val(data.tmenu.icon);
                        $("#name").val(data.tmenu.name);
                        $("#url").val(data.tmenu.url);
                        layerid=layer.open({//开启表单弹层
                            skin: 'layui-layer-molv',
                            area:'60%',
                            type: 1,
                            title:'新建菜单节点',
                            content: $('#addeditformdivid') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                        });
                    }
                }
            });
            
            return false;
        }
        
      //鼠标悬浮时临时添加按钮
       function addHoverDom(treeId, treeNode) {
           //3级目录不可再增加子菜单
           if(treeNode.state=='3'||treeNode.name=='菜单管理'){
               return false;
           }else{
               var sObj = $("#" + treeNode.tId + "_span");
               if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
               var addStr = "<span class='button add' id='addBtn_" + treeNode.tId+ "' title='增加' onfocus='this.blur();'></span>";
               sObj.after(addStr);
               var btn = $("#addBtn_"+treeNode.tId);
               if (btn) btn.bind("click", function(){//点击加号时触发
                   var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                   //初始化新增表单
                   $("#editlabelpId").html(treeNode.id);//设置父节点id，表单中仅需要提供父级节点的id即可，后台会根据pId查询
                   $("#reset").click();//重置表单(新建时在进入表单前要重置一下表单的内容，不然表单打开后会显示上一次的表单的内容。这里调用表单中重置按钮的点击方法来重置)
                   layerid=layer.open({//开启表单弹层
                       skin: 'layui-layer-molv',
                       area:'60%',
                       type: 1,
                       title:'新建菜单节点',
                       content: $('#addeditformdivid') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                   });
                   //zTree.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, name:"new node" + (newCount++)});
                   return false;
               });
           }
       };
	</script>
	
</head>
<body>
<div  id="setpermisdiv">
    <ul id="treeDemo" class="ztree"></ul>
</div>
<div id="addeditformdivid" hidden="">
    <form class="layui-form" action="" id="addeditformid">
        <label hidden="true" id="editlabelid"></label>
        <input id="editid" name="id" value="" hidden/>
        <label hidden="true" id="editlabelpId"></label>
        <input id="pId" name="p_id" value="" hidden/>
        <label hidden="true" id="tId"></label>
        <div class="layui-form-item">
            <label class="layui-form-label">图标</label>
            <div class="layui-input-block">
                <button class="layui-btn" id="choseIcon">选择图标</button>
                <input type="text" id="icon" name="icon" autocomplete="off" lay-verify="content"  placeholder="请输入图标" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">菜单名称</label>
            <div class="layui-input-block">
                <input type="text" id="name" name="name" lay-verify="content"  autocomplete="off" placeholder="请输入菜单名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">url</label>
            <div class="layui-input-block">
                <input type="text" id="url" name="url" lay-verify="content" autocomplete="off" placeholder="请输入url" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="addeditsubmitfilter">立即提交</button>
                <button id="reset" type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>
</body>
</html>